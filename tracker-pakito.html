<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GPS Tracker Valpara√≠so">
    <meta name="application-name" content="GPS Tracker Valpara√≠so">
    <title>GPS Tracker Pakito - Valpara√≠so SP Offline</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
            touch-action: manipulation;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            font-size: 15px;
        }

        .gps-icon {
            width: 18px;
            height: 18px;
            background: #2563eb;
            border-radius: 50%;
            position: relative;
            animation: pulse 2s infinite;
        }

        .gps-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }

        .status-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 10px;
        }

        .status {
            color: #94a3b8;
        }

        .offline-status {
            color: #10b981;
            font-weight: bold;
            margin-top: 2px;
        }

        .offline-ready {
            color: #8b5cf6 !important;
        }

        .map-container {
            flex: 1;
            position: relative;
            background: #0f172a;
            overflow: hidden;
            margin-bottom: 150px;
        }

        .map-canvas {
            width: 100%;
            height: 100%;
            position: relative;
            background: #0f172a;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .leaflet-container {
            background: #0f172a !important;
        }

        .download-panel {
            position: fixed;
            top: 50px;
            left: 8px;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 12px;
            padding: 12px;
            z-index: 1000;
            min-width: 260px;
            max-width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .download-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
            color: #3b82f6;
            font-weight: bold;
            font-size: 13px;
        }

        .coverage-info {
            font-size: 10px;
            color: #94a3b8;
            margin-bottom: 12px;
            line-height: 1.4;
            padding: 8px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 6px;
        }

        .download-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .zoom-control {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }

        .zoom-slider {
            flex: 1;
            height: 4px;
            background: #334155;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .zoom-slider::-webkit-slider-thumb {
            appearance: none;
            width: 14px;
            height: 14px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }

        .download-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            color: white;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .download-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .download-button:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }

        .download-button.complete {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .download-button.complete:hover:not(:disabled) {
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .clear-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
        }

        .clear-button:hover:not(:disabled) {
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4) !important;
        }

        .progress-container {
            margin: 8px 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            width: 0%;
            transition: width 0.2s ease;
        }

        .progress-text {
            font-size: 9px;
            color: #94a3b8;
            text-align: center;
        }

        .storage-info {
            font-size: 9px;
            color: #64748b;
            margin-top: 8px;
            padding: 6px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 5px;
            text-align: center;
        }

        .compass {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 60px;
            height: 60px;
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .compass::before {
            content: '';
            position: absolute;
            top: 6px;
            left: 50%;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 18px solid #ef4444;
            transform: translateX(-50%);
            z-index: 1;
        }

        .compass::after {
            content: 'N';
            position: absolute;
            top: 3px;
            color: #ef4444;
            font-weight: bold;
            font-size: 9px;
            z-index: 2;
        }

        .info-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(148, 163, 184, 0.2);
            z-index: 1000;
            padding: 12px;
        }

        .coordinates-compact {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .coord-compact {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
        }

        .coord-label-compact {
            font-size: 9px;
            color: #94a3b8;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .coord-value-compact {
            font-size: 11px;
            font-weight: bold;
            color: #3b82f6;
            font-family: 'Courier New', monospace;
            text-align: center;
            line-height: 1.2;
        }

        .share-buttons-container {
            display: flex;
            gap: 6px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .share-button-fixed {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            padding: 12px 14px;
            border-radius: 10px;
            color: white;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            box-shadow: 0 3px 12px rgba(59, 130, 246, 0.4);
        }

        .share-summary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            box-shadow: 0 3px 12px rgba(16, 185, 129, 0.4) !important;
        }

        .share-button-fixed:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 18px rgba(59, 130, 246, 0.5);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            color: #94a3b8;
            z-index: 100;
        }

        .spinner {
            width: 35px;
            height: 35px;
            border: 3px solid rgba(148, 163, 184, 0.2);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 11px;
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
            transition: all 0.3s ease;
        }

        .success-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toggle-panel {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(59, 130, 246, 0.9);
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .toggle-panel:hover {
            background: rgba(59, 130, 246, 1);
            transform: translateY(-1px);
        }

        .hidden {
            display: none !important;
        }

        .coverage-circle {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .download-panel {
                top: 45px;
                left: 4px;
                right: 4px;
                max-width: none;
                min-width: auto;
            }
            
            .coordinates-compact {
                gap: 15px;
            }
            
            .coord-compact {
                min-width: 65px;
            }
            
            .info-panel {
                padding: 10px;
            }
            
            .map-container {
                margin-bottom: 130px;
            }

            .compass {
                width: 50px;
                height: 50px;
                top: 10px;
                right: 10px;
            }

            .compass::before {
                border-left: 4px solid transparent;
                border-right: 4px solid transparent;
                border-bottom: 15px solid #ef4444;
            }

            .header {
                padding: 6px 12px;
            }

            .logo {
                font-size: 14px;
            }
        }

        /* Estilos para tiles offline do Google */
        .offline-tile {
            filter: brightness(0.9) contrast(1.1);
        }

        .leaflet-tile-container {
            transform: none !important;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="header">
            <div class="logo">
                <div class="gps-icon"></div>
                <span>Pakito Valpara√≠so</span>
            </div>
            <div class="status-info">
                <div class="status" id="status">Aguardando GPS...</div>
                <div class="offline-status" id="offlineStatus">üì∂ Online</div>
            </div>
        </div>

        <button class="toggle-panel" onclick="toggleDownloadPanel()">
            üó∫Ô∏è Offline
        </button>

        <div class="download-panel hidden" id="downloadPanel">
            <div class="download-header">
                üåç Mapas Google - Valpara√≠so SP
            </div>
            
            <div class="coverage-info">
                <strong>üìç √Årea de Cobertura:</strong><br>
                ‚Ä¢ Centro: Valpara√≠so-SP<br>
                ‚Ä¢ Raio: 200km (40.000 km¬≤)<br>
                ‚Ä¢ Inclui: Grande SP, Interior, Litoral
            </div>
            
            <div class="download-controls">
                <div class="zoom-control">
                    <span>Zoom:</span>
                    <input type="range" class="zoom-slider" id="maxZoomSlider" min="8" max="16" value="13">
                    <span id="zoomValue">13</span>
                </div>
                
                <button class="download-button" id="satelliteBtn" onclick="downloadLayer('satellite')">
                    üõ∞Ô∏è Baixar Sat√©lite
                </button>
                
                <button class="download-button" id="hybridBtn" onclick="downloadLayer('hybrid')">
                    üåç Baixar H√≠brido
                </button>
                
                <button class="download-button complete" id="downloadAllBtn" onclick="downloadAll()">
                    ‚ö° Baixar Todos
                </button>
                
                <button class="download-button clear-button" id="clearBtn" onclick="clearOfflineData()">
                    üóëÔ∏è Limpar Cache
                </button>
                
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText"></div>
                </div>
                
                <div class="storage-info" id="storageInfo">
                    Cache: 0 MB | Tiles: 0
                </div>
            </div>
        </div>

        <div class="map-container">
            <div class="map-canvas" id="mapCanvas">
                <div id="map"></div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Obtendo localiza√ß√£o GPS...</p>
                    <small>Permitir acesso √† localiza√ß√£o</small>
                </div>
                <div class="compass" id="compass">
                    <span id="heading">0¬∞</span>
                </div>
            </div>
        </div>

        <div class="info-panel" id="infoPanel">
            <div class="coordinates-compact">
                <div class="coord-compact">
                    <div class="coord-label-compact">Latitude</div>
                    <div class="coord-value-compact" id="latitude">--</div>
                </div>
                <div class="coord-compact">
                    <div class="coord-label-compact">Longitude</div>
                    <div class="coord-value-compact" id="longitude">--</div>
                </div>
                <div class="coord-compact">
                    <div class="coord-label-compact">Precis√£o</div>
                    <div class="coord-value-compact" id="accuracy">-- m</div>
                </div>
                <div class="coord-compact">
                    <div class="coord-label-compact">Dist√¢ncia</div>
                    <div class="coord-value-compact" id="distance">-- km</div>
                </div>
            </div>

            <div class="share-buttons-container">
                <button class="share-button-fixed share-complete" onclick="shareLocation('complete')">
                    üìç Completo
                </button>
                <button class="share-button-fixed share-summary" onclick="shareLocation('summary')">
                    üìã Resumido
                </button>
            </div>
        </div>
    </div>

    <div class="success-message" id="successMessage">
        Localiza√ß√£o copiada!
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        let currentPosition = null;
        let watchId = null;
        let currentHeading = 0;
        let map = null;
        let marker = null;
        let accuracyCircle = null;
        let coverageCircle = null;
        
        // Configura√ß√µes offline
        let offlineDB = null;
        let downloadInProgress = false;
        let currentLayers = {};
        let totalCachedTiles = 0;
        
        // Centro: Valpara√≠so-SP (coordenadas aproximadas da regi√£o)
        const VALPARAISO_CENTER = {
            lat: -21.2178,  // Valpara√≠so SP (regi√£o noroeste)
            lng: -50.8731
        };
        
        const COVERAGE_RADIUS_KM = 200; // 200km de raio
        
        // Configura√ß√µes das camadas Google
        const layerConfigs = {
            osm: {
                name: "OpenStreetMap",
                url: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                maxZoom: 19,
                subdomains: ['a', 'b', 'c']
            },
            satellite: {
                name: "Google Sat√©lite",
                url: "https://mt{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",
                maxZoom: 20,
                subdomains: ['0', '1', '2', '3']
            },
            hybrid: {
                name: "Google H√≠brido",
                url: "https://mt{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",
                maxZoom: 20,
                subdomains: ['0', '1', '2', '3']
            }
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            await initOfflineDB();
            await initializeMap();
            startLocationTracking();
            startCompass();
            updateStorageInfo();
            
            // Slider de zoom
            document.getElementById('maxZoomSlider').addEventListener('input', function() {
                document.getElementById('zoomValue').textContent = this.value;
            });
            
            // Status online/offline
            window.addEventListener('online', updateOfflineStatus);
            window.addEventListener('offline', updateOfflineStatus);
            updateOfflineStatus();

            // Verificar se j√° tem dados offline
            await checkOfflineDataStatus();
        });

        async function initOfflineDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ValparaisoGPSOffline', 2);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    offlineDB = request.result;
                    resolve(offlineDB);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Limpar stores antigos se existirem
                    if (db.objectStoreNames.contains('tiles')) {
                        db.deleteObjectStore('tiles');
                    }
                    
                    // Criar novo store otimizado
                    const store = db.createObjectStore('tiles', { keyPath: 'key' });
                    store.createIndex('layer', 'layer', { unique: false });
                    store.createIndex('zoom', 'z', { unique: false });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                };
            });
        }

        async function initializeMap() {
            // Centralizar em Valpara√≠so-SP
            map = L.map('map', {
                center: [VALPARAISO_CENTER.lat, VALPARAISO_CENTER.lng],
                zoom: 10,
                zoomControl: true,
                attributionControl: false,
                preferCanvas: true,
                maxZoom: 20,
                minZoom: 8,
                zoomSnap: 0.5
            });

            // Criar camadas com cache offline otimizado
            const offlineOSM = createOfflineLayer('osm');
            const offlineSatellite = createOfflineLayer('satellite');
            const offlineHybrid = createOfflineLayer('hybrid');

            // Adicionar camada padr√£o
            offlineOSM.addTo(map);

            // Controle de camadas
            const baseLayers = {
                "üó∫Ô∏è Padr√£o": offlineOSM,
                "üõ∞Ô∏è Sat√©lite": offlineSatellite,
                "üåç H√≠brido": offlineHybrid
            };

            L.control.layers(baseLayers, null, {
                position: 'topleft',
                collapsed: false
            }).addTo(map);

            currentLayers = {
                osm: offlineOSM,
                satellite: offlineSatellite,
                hybrid: offlineHybrid
            };

            // Adicionar c√≠rculo de cobertura
            addCoverageCircle();
            
            // Controles personalizados
            addCustomControls();
        }

        function createOfflineLayer(layerType) {
            const config = layerConfigs[layerType];
            
            return L.tileLayer(config.url, {
                attribution: `¬© ${config.name}`,
                maxZoom: config.maxZoom,
                crossOrigin: true,
                subdomains: config.subdomains || ['a', 'b', 'c'],
                className: 'offline-tile',
                // Interceptar carregamento de tiles
                tileLoadFunction: async function(tile, url) {
                    await loadTileWithCache(tile, url, layerType);
                }
            });
        }

        async function loadTileWithCache(tile, url, layerType) {
            try {
                // Extrair coordenadas da URL
                const coords = extractTileCoords(url);
                if (!coords) {
                    tile.src = url;
                    return;
                }
                
                const tileKey = `${layerType}_${coords.z}_${coords.x}_${coords.y}`;
                
                // Verificar se est√° dentro da √°rea de cobertura
                if (!isWithinCoverage(coords)) {
                    tile.src = createEmptyTile('Fora da √°rea');
                    return;
                }
                
                // Tentar carregar do cache primeiro
                const cachedTile = await getCachedTile(tileKey);
                if (cachedTile) {
                    tile.src = cachedTile.blob;
                    return;
                }
                
                // Se offline e n√£o h√° cache, mostrar tile vazio
                if (!navigator.onLine) {
                    tile.src = createEmptyTile('Offline');
                    return;
                }
                
                // Carregar do servidor com retry
                await loadAndCacheTile(tile, url, tileKey, layerType, coords);
                
            } catch (error) {
                console.log('Erro ao carregar tile:', error);
                tile.src = url; // Fallback
            }
        }

        async function loadAndCacheTile(tile, url, tileKey, layerType, coords) {
            const maxRetries = 3;
            let retries = 0;
            
            while (retries < maxRetries) {
                try {
                    // Substituir subdomain randomicamente para balanceamento
                    const config = layerConfigs[layerType];
                    const subdomain = config.subdomains[Math.floor(Math.random() * config.subdomains.length)];
                    const finalUrl = url.replace('{s}', subdomain);
                    
                    const response = await fetch(finalUrl, {
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const dataUrl = await blobToDataUrl(blob);
                        
                        // Salvar no cache de forma ass√≠ncrona
                        saveTileToCache(tileKey, {
                            key: tileKey,
                            layer: layerType,
                            z: coords.z,
                            x: coords.x,
                            y: coords.y,
                            blob: dataUrl,
                            size: blob.size,
                            timestamp: Date.now()
                        });
                        
                        tile.src = dataUrl;
                        return;
                    }
                } catch (error) {
                    retries++;
                    if (retries < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 1000 * retries));
                    }
                }
            }
            
            // Se falhou todas as tentativas, usar URL original
            tile.src = url;
        }

        function extractTileCoords(url) {
            const match = url.match(/[xyz]=(\d+)/g);
            if (!match || match.length < 3) return null;
            
            const coords = {};
            match.forEach(param => {
                const [key, value] = param.split('=');
                coords[key] = parseInt(value);
            });
            
            return coords.x !== undefined && coords.y !== undefined && coords.z !== undefined ? coords : null;
        }

        function isWithinCoverage(coords) {
            // Converter tile para lat/lng
            const tileBounds = tileToLatLng(coords.x, coords.y, coords.z);
            const centerLat = (tileBounds.north + tileBounds.south) / 2;
            const centerLng = (tileBounds.east + tileBounds.west) / 2;
            
            // Calcular dist√¢ncia do centro de Valpara√≠so
            const distance = calculateDistance(
                VALPARAISO_CENTER.lat, VALPARAISO_CENTER.lng,
                centerLat, centerLng
            );
            
            return distance <= COVERAGE_RADIUS_KM;
        }

        function tileToLatLng(x, y, z) {
            const n = Math.pow(2, z);
            const lonMin = (x / n) * 360 - 180;
            const lonMax = ((x + 1) / n) * 360 - 180;
            const latMaxRad = Math.atan(Math.sinh(Math.PI * (1 - 2 * y / n)));
            const latMinRad = Math.atan(Math.sinh(Math.PI * (1 - 2 * (y + 1) / n)));
            
            return {
                north: latMaxRad * 180 / Math.PI,
                south: latMinRad * 180 / Math.PI,
                east: lonMax,
                west: lonMin
            };
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function getCachedTile(key) {
            if (!offlineDB) return null;
            
            return new Promise((resolve) => {
                const transaction = offlineDB.transaction(['tiles'], 'readonly');
                const store = transaction.objectStore('tiles');
                const request = store.get(key);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve(null);
            });
        }

        async function saveTileToCache(key, data) {
            if (!offlineDB) return;
            
            try {
                const transaction = offlineDB.transaction(['tiles'], 'readwrite');
                const store = transaction.objectStore('tiles');
                await store.put(data);
            } catch (error) {
                console.log('Erro ao salvar tile:', error);
            }
        }

        function createEmptyTile(message = 'Offline') {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            // Fundo escuro
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, 256, 256);
            
            // Borda
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, 256, 256);
            
            // Texto
            ctx.fillStyle = '#6b7280';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(message, 128, 128);
            
            return canvas.toDataURL();
        }

        function blobToDataUrl(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

        function addCoverageCircle() {
            // Adicionar c√≠rculo visual da √°rea de cobertura
            coverageCircle = L.circle([VALPARAISO_CENTER.lat, VALPARAISO_CENTER.lng], {
                radius: COVERAGE_RADIUS_KM * 1000, // metros
                color: '#8b5cf6',
                fillColor: '#8b5cf6',
                fillOpacity: 0.05,
                weight: 2,
                dashArray: '10, 10',
                opacity: 0.6
            }).addTo(map);

            // Popup informativo
            coverageCircle.bindPopup(`
                <div style="color: #1e293b; font-family: Arial; font-size: 12px;">
                    <h4 style="color: #8b5cf6; margin: 0 0 8px 0;">üåç √Årea de Cobertura</h4>
                    <p><strong>Centro:</strong> Valpara√≠so-SP</p>
                    <p><strong>Raio:</strong> ${COVERAGE_RADIUS_KM} km</p>
                    <p><strong>√Årea:</strong> ~${Math.round(Math.PI * COVERAGE_RADIUS_KM * COVERAGE_RADIUS_KM / 1000)} mil km¬≤</p>
                </div>
            `);
        }

        async function downloadLayer(layerType) {
            if (downloadInProgress) return;
            
            const button = document.getElementById(`${layerType}Btn`);
            if (!button) return;
            
            downloadInProgress = true;
            button.disabled = true;
            button.textContent = '‚è≥ Baixando...';
            
            await performDownload([layerType]);
            
            button.disabled = false;
            button.textContent = layerType === 'satellite' ? 'üõ∞Ô∏è Baixar Sat√©lite' : 'üåç Baixar H√≠brido';
            downloadInProgress = false;
        }

        async function downloadAll() {
            if (downloadInProgress) return;
            
            const button = document.getElementById('downloadAllBtn');
            button.disabled = true;
            button.textContent = '‚ö° Baixando Todos...';
            
            downloadInProgress = true;
            await performDownload(['satellite', 'hybrid']);
            downloadInProgress = false;
            
            button.disabled = false;
            button.textContent = '‚ö° Baixar Todos';
        }

        async function performDownload(layers) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            
            const maxZoom = parseInt(document.getElementById('maxZoomSlider').value);
            let totalTiles = 0;
            let downloadedTiles = 0;
            
            // Calcular total de tiles dentro da √°rea de cobertura
            for (let layer of layers) {
                for (let z = 8; z <= maxZoom; z++) {
                    const tilesInZoom = getTilesInCoverageArea(z);
                    totalTiles += tilesInZoom.length;
                }
            }
            
            progressText.textContent = `Preparando download de ${totalTiles} tiles...`;
            
            try {
                for (let layer of layers) {
                    for (let z = 8; z <= maxZoom; z++) {
                        if (!downloadInProgress) break;
                        
                        const tiles = getTilesInCoverageArea(z);
                        
                        // Download em lotes para otimiza√ß√£o
                        const batchSize = 5;
                        for (let i = 0; i < tiles.length; i += batchSize) {
                            if (!downloadInProgress) break;
                            
                            const batch = tiles.slice(i, i + batchSize);
                            const downloadPromises = batch.map(tile => 
                                downloadSingleTile(layer, tile.z, tile.x, tile.y)
                            );
                            
                            await Promise.allSettled(downloadPromises);
                            downloadedTiles += batch.length;
                            
                            const progress = (downloadedTiles / totalTiles) * 100;
                            progressFill.style.width = `${progress}%`;
                            progressText.textContent = `${downloadedTiles}/${totalTiles} tiles (${progress.toFixed(1)}%) - ${layer}`;
                            
                            // Pausa para n√£o sobrecarregar
                            if (i % 20 === 0) {
                                await new Promise(resolve => setTimeout(resolve, 200));
                                updateStorageInfo();
                            }
                        }
                    }
                }
                
                progressText.textContent = `‚úÖ Download conclu√≠do! ${downloadedTiles} tiles baixados`;
                showSuccess('Mapas offline prontos!');
                
                // Atualizar status
                await checkOfflineDataStatus();
                
            } catch (error) {
                console.error('Erro no download:', error);
                progressText.textContent = `‚ùå Erro no download. ${downloadedTiles} tiles salvos.`;
            }
            
            updateStorageInfo();
        }

        function getTilesInCoverageArea(zoom) {
            const tiles = [];
            const bounds = getCoverageTileBounds(zoom);
            
            for (let x = bounds.minX; x <= bounds.maxX; x++) {
                for (let y = bounds.minY; y <= bounds.maxY; y++) {
                    // Verificar se o tile est√° realmente dentro do c√≠rculo
                    if (isWithinCoverage({x, y, z: zoom})) {
                        tiles.push({x, y, z: zoom});
                    }
                }
            }
            
            return tiles;
        }

        function getCoverageTileBounds(zoom) {
            // Calcular bounds do quadrado que engloba o c√≠rculo
            const kmPerDegree = 111.32; // km por grau aproximadamente
            const degreesRadius = COVERAGE_RADIUS_KM / kmPerDegree;
            
            const minLat = VALPARAISO_CENTER.lat - degreesRadius;
            const maxLat = VALPARAISO_CENTER.lat + degreesRadius;
            const minLng = VALPARAISO_CENTER.lng - degreesRadius;
            const maxLng = VALPARAISO_CENTER.lng + degreesRadius;
            
            const minTile = latLngToTile(maxLat, minLng, zoom);
            const maxTile = latLngToTile(minLat, maxLng, zoom);
            
            return {
                minX: Math.max(0, minTile.x),
                minY: Math.max(0, minTile.y),
                maxX: Math.min(Math.pow(2, zoom) - 1, maxTile.x),
                maxY: Math.min(Math.pow(2, zoom) - 1, maxTile.y)
            };
        }

        function latLngToTile(lat, lng, zoom) {
            const latRad = lat * Math.PI / 180;
            const n = Math.pow(2, zoom);
            const x = Math.floor((lng + 180) / 360 * n);
            const y = Math.floor((1 - Math.asinh(Math.tan(latRad)) / Math.PI) / 2 * n);
            return { x, y };
        }

        async function downloadSingleTile(layer, z, x, y) {
            const tileKey = `${layer}_${z}_${x}_${y}`;
            
            // Verificar se j√° existe
            const existing = await getCachedTile(tileKey);
            if (existing) return;
            
            try {
                const config = layerConfigs[layer];
                const subdomain = config.subdomains[Math.floor(Math.random() * config.subdomains.length)];
                let url = config.url
                    .replace('{z}', z)
                    .replace('{x}', x)
                    .replace('{y}', y)
                    .replace('{s}', subdomain);
                
                const response = await fetch(url, {
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const dataUrl = await blobToDataUrl(blob);
                    
                    await saveTileToCache(tileKey, {
                        key: tileKey,
                        layer: layer,
                        z: z,
                        x: x,
                        y: y,
                        blob: dataUrl,
                        size: blob.size,
                        timestamp: Date.now()
                    });
                }
            } catch (error) {
                console.log(`Erro ao baixar tile ${tileKey}`);
            }
        }

        async function clearOfflineData() {
            if (!offlineDB || downloadInProgress) return;
            
            if (confirm('Limpar todos os mapas offline? Esta a√ß√£o n√£o pode ser desfeita.')) {
                try {
                    const transaction = offlineDB.transaction(['tiles'], 'readwrite');
                    const store = transaction.objectStore('tiles');
                    await store.clear();
                    
                    totalCachedTiles = 0;
                    updateStorageInfo();
                    await checkOfflineDataStatus();
                    showSuccess('Cache limpo com sucesso!');
                } catch (error) {
                    console.error('Erro ao limpar cache:', error);
                }
            }
        }

        async function updateStorageInfo() {
            if (!offlineDB) return;
            
            try {
                const transaction = offlineDB.transaction(['tiles'], 'readonly');
                const store = transaction.objectStore('tiles');
                
                // Contar tiles e estimar tamanho
                let count = 0;
                let totalSize = 0;
                
                const request = store.openCursor();
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        count++;
                        totalSize += cursor.value.size || 15000; // 15KB estimado por tile
                        cursor.continue();
                    } else {
                        const sizeMB = (totalSize / 1024 / 1024).toFixed(1);
                        document.getElementById('storageInfo').textContent = 
                            `Cache: ${sizeMB} MB | Tiles: ${count}`;
                        totalCachedTiles = count;
                    }
                };
            } catch (error) {
                console.error('Erro ao calcular storage:', error);
            }
        }

        async function checkOfflineDataStatus() {
            if (totalCachedTiles > 100) { // Se tem dados offline substanciais
                document.getElementById('offlineStatus').textContent = 'üó∫Ô∏è Offline Ready';
                document.getElementById('offlineStatus').className = 'offline-status offline-ready';
            } else {
                updateOfflineStatus();
            }
        }

        function updateOfflineStatus() {
            const statusEl = document.getElementById('offlineStatus');
            if (navigator.onLine) {
                statusEl.textContent = 'üì∂ Online';
                statusEl.className = 'offline-status';
            } else {
                statusEl.textContent = 'üì¥ Offline';
                statusEl.className = 'offline-status';
                statusEl.style.color = '#f59e0b';
            }
        }

        function toggleDownloadPanel() {
            const panel = document.getElementById('downloadPanel');
            panel.classList.toggle('hidden');
        }

        function addCustomControls() {
            const customControl = L.Control.extend({
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'custom-control');
                    container.style.cssText = `
                        background: rgba(15, 23, 42, 0.9);
                        padding: 5px;
                        border-radius: 5px;
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(148, 163, 184, 0.2);
                        display: flex;
                        flex-direction: column;
                        gap: 3px;
                    `;
                    
                    // Bot√£o centralizar
                    const centerBtn = L.DomUtil.create('button', '', container);
                    centerBtn.innerHTML = 'üéØ';
                    centerBtn.style.cssText = `
                        background: #3b82f6; border: none; color: white;
                        padding: 5px; border-radius: 3px; cursor: pointer; font-size: 11px;
                    `;
                    centerBtn.title = 'Centralizar na localiza√ß√£o';
                    centerBtn.onclick = () => {
                        if (currentPosition) {
                            map.setView([currentPosition.coords.latitude, currentPosition.coords.longitude], map.getZoom());
                        }
                    };

                    // Bot√£o zoom
                    const zoomBtn = L.DomUtil.create('button', '', container);
                    zoomBtn.innerHTML = 'üîç';
                    zoomBtn.style.cssText = `
                        background: #10b981; border: none; color: white;
                        padding: 5px; border-radius: 3px; cursor: pointer; font-size: 11px;
                    `;
                    zoomBtn.title = 'Zoom na localiza√ß√£o';
                    zoomBtn.onclick = () => {
                        if (currentPosition) {
                            map.setView([currentPosition.coords.latitude, currentPosition.coords.longitude], 16);
                        }
                    };

                    // Bot√£o para Valpara√≠so
                    const valparaisoBtn = L.DomUtil.create('button', '', container);
                    valparaisoBtn.innerHTML = 'üè†';
                    valparaisoBtn.style.cssText = `
                        background: #8b5cf6; border: none; color: white;
                        padding: 5px; border-radius: 3px; cursor: pointer; font-size: 11px;
                    `;
                    valparaisoBtn.title = 'Ir para Valpara√≠so';
                    valparaisoBtn.onclick = () => {
                        map.setView([VALPARAISO_CENTER.lat, VALPARAISO_CENTER.lng], 12);
                    };

                    return container;
                }
            });

            new customControl({ position: 'topright' }).addTo(map);
        }

        function startLocationTracking() {
            if (!navigator.geolocation) {
                showError('Geolocaliza√ß√£o n√£o suportada');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 2000
            };

            navigator.geolocation.getCurrentPosition(updatePosition, handleError, options);
            watchId = navigator.geolocation.watchPosition(updatePosition, handleError, options);
            
            // Atualiza√ß√£o peri√≥dica mais frequente
            setInterval(() => {
                navigator.geolocation.getCurrentPosition(
                    updatePosition,
                    () => {},
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }, 3000);
        }

        function updatePosition(position) {
            currentPosition = position;
            
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            document.getElementById('loading').style.display = 'none';

            if (map) {
                // Remover marcadores anteriores
                if (marker) map.removeLayer(marker);
                if (accuracyCircle) map.removeLayer(accuracyCircle);

                // √çcone do marcador baseado na precis√£o
                let markerColor = '#ef4444';
                if (accuracy <= 5) markerColor = '#10b981';
                else if (accuracy <= 15) markerColor = '#f59e0b';

                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `
                        <div style="
                            width: 14px; height: 14px; background: ${markerColor};
                            border: 2px solid white; border-radius: 50%;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        "></div>
                    `,
                    iconSize: [18, 18],
                    iconAnchor: [9, 9]
                });

                marker = L.marker([lat, lon], { 
                    icon: customIcon,
                    title: `${lat.toFixed(6)}, ${lon.toFixed(6)}`
                }).addTo(map);

                // C√≠rculo de precis√£o
                if (accuracy) {
                    accuracyCircle = L.circle([lat, lon], {
                        radius: accuracy,
                        color: markerColor,
                        fillColor: markerColor,
                        fillOpacity: 0.1,
                        weight: 1,
                        dashArray: accuracy > 20 ? '3, 3' : null
                    }).addTo(map);
                }

                // Calcular dist√¢ncia de Valpara√≠so
                const distanceToValparaiso = calculateDistance(
                    VALPARAISO_CENTER.lat, VALPARAISO_CENTER.lng, lat, lon
                );

                // Popup
                marker.bindPopup(`
                    <div style="color: #1e293b; font-family: Arial; font-size: 11px;">
                        <h4 style="color: #3b82f6; margin: 0 0 6px 0;">üìç Localiza√ß√£o Atual</h4>
                        <p><strong>Lat:</strong> ${lat.toFixed(6)}¬∞</p>
                        <p><strong>Lng:</strong> ${lon.toFixed(6)}¬∞</p>
                        <p><strong>Precis√£o:</strong> ${accuracy?.toFixed(1)}m</p>
                        <p><strong>Dist√¢ncia de Valpara√≠so:</strong> ${distanceToValparaiso.toFixed(1)}km</p>
                        <p><strong>Hora:</strong> ${new Date().toLocaleTimeString()}</p>
                    </div>
                `);

                // Atualizar dist√¢ncia na interface
                document.getElementById('distance').textContent = `${distanceToValparaiso.toFixed(1)} km`;
            }
            
            // Atualizar coordenadas
            document.getElementById('latitude').textContent = lat.toFixed(6);
            document.getElementById('longitude').textContent = lon.toFixed(6);
            document.getElementById('accuracy').textContent = 
                accuracy ? `${accuracy.toFixed(1)} m` : '-- m';
            
            // Status GPS
            let statusText = 'GPS Ativo';
            let statusColor = '#10b981';
            
            if (accuracy <= 5) {
                statusText = 'GPS Excelente';
            } else if (accuracy <= 15) {
                statusText = 'GPS Bom';
            } else if (accuracy <= 50) {
                statusText = 'GPS Moderado';
                statusColor = '#f59e0b';
            } else {
                statusText = 'GPS Baixo';
                statusColor = '#ef4444';
            }
            
            document.getElementById('status').textContent = statusText;
            document.getElementById('status').style.color = statusColor;
        }

        function handleError(error) {
            const messages = {
                [error.PERMISSION_DENIED]: 'Permiss√£o GPS negada',
                [error.POSITION_UNAVAILABLE]: 'GPS indispon√≠vel',
                [error.TIMEOUT]: 'Timeout GPS'
            };
            
            const message = messages[error.code] || 'Erro GPS';
            document.getElementById('status').textContent = message;
            document.getElementById('status').style.color = '#ef4444';
        }

        function startCompass() {
            if ('DeviceOrientationEvent' in window) {
                window.addEventListener('deviceorientationabsolute', handleOrientation);
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function handleOrientation(event) {
            if (event.alpha !== null) {
                currentHeading = 360 - event.alpha;
                document.getElementById('compass').style.transform = `rotate(${currentHeading}deg)`;
                document.getElementById('heading').textContent = `${Math.round(currentHeading)}¬∞`;
            }
        }

        async function shareLocation(type = 'complete') {
            if (!currentPosition) {
                alert('Aguarde a localiza√ß√£o GPS');
                return;
            }

            const lat = currentPosition.coords.latitude;
            const lon = currentPosition.coords.longitude;
            const accuracy = currentPosition.coords.accuracy;
            
            // Calcular dist√¢ncia de Valpara√≠so
            const distance = calculateDistance(
                VALPARAISO_CENTER.lat, VALPARAISO_CENTER.lng, lat, lon
            );
            
            let message;
            
            if (type === 'summary') {
                message = `üìç LOCALIZA√á√ÉO GPS - Valpara√≠so SP
				
üó∫Ô∏è ${lat.toFixed(6)}, ${lon.toFixed(6)}
üéØ Precis√£o: ${accuracy?.toFixed(1)}m
üìè ${distance.toFixed(1)}km de Valpara√≠so

üîó https://maps.google.com/?q=${lat},${lon}

‚ö° Pakito Tracker Valpara√≠so`;
            } else {
                message = `üåç LOCALIZA√á√ÉO COMPLETA - Regi√£o Valpara√≠so SP
            
üìç Coordenadas GPS:
‚Ä¢ Latitude: ${lat.toFixed(6)}¬∞
‚Ä¢ Longitude: ${lon.toFixed(6)}¬∞
‚Ä¢ Precis√£o: ${accuracy?.toFixed(1)}m

üìè Refer√™ncias:
‚Ä¢ Dist√¢ncia de Valpara√≠so: ${distance.toFixed(1)} km
‚Ä¢ Dentro da √°rea de cobertura: ${distance <= COVERAGE_RADIUS_KM ? 'Sim' : 'N√£o'}

üó∫Ô∏è Links de Mapas:
‚Ä¢ Google Maps: https://maps.google.com/?q=${lat},${lon}
‚Ä¢ Apple Maps: https://maps.apple.com/?ll=${lat},${lon}
‚Ä¢ Waze: https://waze.com/ul?ll=${lat},${lon}

‚è∞ Hor√°rio: ${new Date().toLocaleString('pt-BR')}
üß≠ Dire√ß√£o: ${Math.round(currentHeading)}¬∞
${navigator.onLine ? 'üì∂' : 'üì¥'} Status: ${navigator.onLine ? 'Online' : 'Offline'}

‚ö° GPS Tracker Pakito - Valpara√≠so SP`;
            }

            try {
                // Copiar para clipboard
                if (navigator.clipboard) {
                    await navigator.clipboard.writeText(message);
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = message;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }

                // Compartilhar nativamente se dispon√≠vel
                if (navigator.share) {
                    await navigator.share({
                        title: 'Localiza√ß√£o GPS - Valpara√≠so SP',
                        text: message
                    });
                }

                showSuccess('Localiza√ß√£o copiada!');
                
            } catch (error) {
                console.error('Erro ao compartilhar:', error);
                showLocationModal(message);
            }
        }

        function showSuccess(message = 'Localiza√ß√£o copiada!') {
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = message;
            successMsg.classList.add('show');
            
            setTimeout(() => {
                successMsg.classList.remove('show');
            }, 2500);
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            alert(message);
        }

        function showLocationModal(message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); display: flex; align-items: center;
                justify-content: center; z-index: 9999; padding: 15px;
            `;
            
            modal.innerHTML = `
                <div style="background: #1e293b; padding: 20px; border-radius: 10px;
                           max-width: 90%; max-height: 80%; overflow-y: auto;">
                    <h3 style="color: white; margin-bottom: 12px; text-align: center;">üìç Localiza√ß√£o</h3>
                    <textarea readonly style="width: 100%; height: 200px; background: #0f172a;
                                            color: white; border: 1px solid #374151; border-radius: 5px;
                                            padding: 10px; font-family: monospace; font-size: 10px;
                                            margin-bottom: 12px;">${message}</textarea>
                    <div style="display: flex; gap: 8px; justify-content: center;">
                        <button onclick="copyToClipboard('${message.replace(/'/g, "\\'")}'); this.textContent='‚úÖ Copiado!'" 
                                style="background: #3b82f6; color: white; border: none; padding: 8px 12px;
                                       border-radius: 5px; cursor: pointer; font-size: 11px;">Copiar</button>
                        <button onclick="document.body.removeChild(this.closest('div'))" 
                                style="background: #6b7280; color: white; border: none; padding: 8px 12px;
                                       border-radius: 5px; cursor: pointer; font-size: 11px;">Fechar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text);
            } else {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
            showSuccess('Texto copiado!');
        }

        // Cleanup e wake lock
        window.addEventListener('beforeunload', function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            downloadInProgress = false;
        });

        // Manter tela ligada
        let wakeLock = null;
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Tela mantida ligada para GPS cont√≠nuo');
                }
            } catch (err) {
                console.log('Wake lock n√£o suportado');
            }
        }

        // Reativar wake lock quando a p√°gina fica vis√≠vel
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        // Service Worker para funcionamento offline
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registrado:', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registro falhou:', registrationError);
                    });
            });
        }

        // Inicializar wake lock
        requestWakeLock();

        // Preload de tiles importantes (centro de Valpara√≠so)
        setTimeout(async () => {
            if (navigator.onLine && totalCachedTiles === 0) {
                // Download autom√°tico b√°sico do centro de Valpara√≠so
                const centerTiles = [
                    { layer: 'satellite', z: 10, x: 592, y: 395 }, // Aproximadamente Valpara√≠so
                    { layer: 'satellite', z: 11, x: 1184, y: 790 },
                    { layer: 'satellite', z: 12, x: 2368, y: 1580 }
                ];
                
                console.log('Fazendo preload de tiles centrais...');
                for (const tile of centerTiles) {
                    await downloadSingleTile(tile.layer, tile.z, tile.x, tile.y);
                }
                updateStorageInfo();
            }
        }, 3000);

        // Detectar quando o dispositivo sai da √°rea de cobertura
        let outsideCoverageWarned = false;
        function checkCoverageArea() {
            if (!currentPosition) return;
            
            const distance = calculateDistance(
                VALPARAISO_CENTER.lat, VALPARAISO_CENTER.lng,
                currentPosition.coords.latitude, currentPosition.coords.longitude
            );
            
            if (distance > COVERAGE_RADIUS_KM && !outsideCoverageWarned) {
                showSuccess('‚ö†Ô∏è Fora da √°rea de cobertura offline!');
                outsideCoverageWarned = true;
            } else if (distance <= COVERAGE_RADIUS_KM && outsideCoverageWarned) {
                showSuccess('‚úÖ De volta √† √°rea de cobertura!');
                outsideCoverageWarned = false;
            }
        }

        // Verificar √°rea de cobertura a cada 10 segundos
        setInterval(checkCoverageArea, 10000);

        // Fun√ß√£o para otimizar performance do mapa
        function optimizeMapPerformance() {
            if (map) {
                // Reduzir tiles desnecess√°rios quando offline
                if (!navigator.onLine) {
                    map.options.maxZoom = 16; // Limitar zoom quando offline
                }
                
                // Limpar tiles antigos periodicamente
                setTimeout(() => {
                    if (map._layers) {
                        Object.values(map._layers).forEach(layer => {
                            if (layer._tiles) {
                                const tileCount = Object.keys(layer._tiles).length;
                                if (tileCount > 100) { // Se muitos tiles carregados
                                    layer.redraw(); // For√ßar limpeza
                                }
                            }
                        });
                    }
                }, 30000); // A cada 30 segundos
            }
        }

        // Executar otimiza√ß√£o periodicamente
        setInterval(optimizeMapPerformance, 60000); // A cada minuto

        // Adicionar evento para mostrar info de debugging (opcional)
        let debugMode = false;
        document.addEventListener('keydown', (e) => {
            if (e.key === 'D' && e.ctrlKey && e.shiftKey) {
                debugMode = !debugMode;
                if (debugMode) {
                    console.log('Debug mode ativado');
                    console.log('Total cached tiles:', totalCachedTiles);
                    console.log('Current position:', currentPosition);
                    console.log('Coverage center:', VALPARAISO_CENTER);
                    console.log('Coverage radius:', COVERAGE_RADIUS_KM);
                } else {
                    console.log('Debug mode desativado');
                }
            }
        });

        // Fun√ß√£o para exportar dados offline (para debug)
        window.exportOfflineData = async function() {
            if (!offlineDB) return;
            
            const transaction = offlineDB.transaction(['tiles'], 'readonly');
            const store = transaction.objectStore('tiles');
            const allTiles = [];
            
            const request = store.openCursor();
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    allTiles.push({
                        key: cursor.value.key,
                        layer: cursor.value.layer,
                        z: cursor.value.z,
                        size: cursor.value.size || 0,
                        timestamp: new Date(cursor.value.timestamp).toLocaleString()
                    });
                    cursor.continue();
                } else {
                    console.log('Tiles offline:', allTiles);
                    console.log(`Total: ${allTiles.length} tiles`);
                    
                    // Agrupar por camada
                    const byLayer = allTiles.reduce((acc, tile) => {
                        acc[tile.layer] = (acc[tile.layer] || 0) + 1;
                        return acc;
                    }, {});
                    console.log('Por camada:', byLayer);
                }
            };
        };

        // Adicionar indicador visual de status offline no mapa
        function addOfflineIndicator() {
            const indicator = L.control({position: 'bottomleft'});
            
            indicator.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'offline-indicator');
                div.style.cssText = `
                    background: rgba(15, 23, 42, 0.9);
                    padding: 5px 8px;
                    border-radius: 5px;
                    font-size: 10px;
                    color: #94a3b8;
                    backdrop-filter: blur(5px);
                    border: 1px solid rgba(148, 163, 184, 0.2);
                `;
                
                function updateIndicator() {
                    if (navigator.onLine) {
                        div.innerHTML = totalCachedTiles > 0 ? 
                            `üì∂ Online ‚Ä¢ ${totalCachedTiles} tiles` : 
                            'üì∂ Online';
                        div.style.color = '#10b981';
                    } else {
                        div.innerHTML = totalCachedTiles > 0 ? 
                            `üì¥ Offline ‚Ä¢ ${totalCachedTiles} tiles` : 
                            'üì¥ Offline ‚Ä¢ Sem cache';
                        div.style.color = totalCachedTiles > 0 ? '#8b5cf6' : '#f59e0b';
                    }
                }
                
                updateIndicator();
                
                // Atualizar indicador quando status muda
                window.addEventListener('online', updateIndicator);
                window.addEventListener('offline', updateIndicator);
                
                // Atualizar quando tiles s√£o baixados
                setInterval(updateIndicator, 5000);
                
                return div;
            };
            
            indicator.addTo(map);
        }

        // Adicionar indicador quando mapa estiver pronto
        setTimeout(addOfflineIndicator, 2000);
    </script>
</body>
</html>
